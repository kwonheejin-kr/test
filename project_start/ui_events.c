//ì£¼ì˜ ì‚¬í•­*
//humidifierì€ label ui, smogëŠ” event ì´ë¦„ìœ¼ë¡œ í˜¼ë™ì˜ ìš”ì†Œê°€ ê°•í•¨


// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.5.0
// LVGL version: 9.1.0
// Project name: SquareLine_Project_change

#include "ui.h"
#include "lvgl.h"
#include "ui_events.h"
#include "BluetoothSerial.h"
#include "Wire.h"
#include "DHT.h"
#include "Adafruit_MAX30102.h"
#include "WiFi.h"
#include "FS.h"
#include "SD.h"
#include "SPI.h"
#include "driver/i2s.h"
#include "sd_utils.h"

#define SD_CS 13  // SD ì¹´ë“œ ì¹© ì…€ë ‰íŠ¸ í•€
#define WIFI_SSID "YOUR_WIFI_SSID"
#define WIFI_PASSWORD "YOUR_WIFI_PASSWORD"
#define SERVER_IP "192.168.1.100"  // ë¼ì¦ˆë² ë¦¬íŒŒì´ IP
#define DHT_PIN 4
#define DHT_TYPE DHT22
#define SLAVE_ADDR 0x08
#define I2S_NUM I2S_NUM_0
#define MUSIC_FILE_PATH "/music.wav"

DHT dht(DHT_PIN, DHT_TYPE);
Adafruit_MAX30102 heartRateSensor;
bool is_measuring = false;
unsigned long start_time = 0;
File heartDataFile;
File musicFile;
bool isPlaying = false;
extern BluetoothSerial SerialBT; //ë¸”ë£¨íˆ¬ìŠ¤ ê°ì²´

//ë¼ì¦ˆë² ë¦¬íŒŒì´ì— ë°ì´í„° ì „ì†¡í•˜ëŠ” ë‚´ìš©



//ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸ìš© íƒ€ì´ë¨¸ í•¸ë“¤ëŸ¬

lv_timer_t * bt_timer= NULL;
unsigned long bt_start_time = 0; //bluetooth for millis

//fan toggle millis êµ¬ì¡°

unsigned long fan_last_request = 0;
bool fan_request_pending = false;

//led toggle millis

unsigned long led_last_request = 0;
bool led_request_pending = false;

//smog toggle millis
unsigned long smog_last_request = 0;
bool smog_request_pending = false;

void request_fan_status(lv_timer_t * timer) {
    if (fan_request_pending && millis() - fan_last_request >= 100) {
        Wire.requestFrom(SLAVE_ADDR, 1);  
        unsigned long start_wait = millis();
        while (!Wire.available() && millis() - start_wait < 50);  // ìµœëŒ€ 50ms ëŒ€ê¸°

        if (Wire.available()) {
            char fan_state = Wire.read();
            lv_label_set_text(ui_fan, (fan_state == '1') ? "Fan ON" : "Fan OFF");
            Serial.print("íŒ¬ ìƒíƒœ ì—…ë°ì´íŠ¸: ");
            Serial.println(fan_state == '1' ? "ON" : "OFF");
        } else {
            Serial.println("íŒ¬ ìƒíƒœ ìš”ì²­ ì‹¤íŒ¨: ì‘ë‹µ ì—†ìŒ.");
        }

        fan_request_pending = false;
    }
}

void fan_toggle(lv_event_t * e)
{
    Serial.println("íŒ¬ í† ê¸€ ëª…ë ¹ ì „ì†¡...");
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write('T');
    Wire.endTransmission();

    fan_last_request = millis();  
    fan_request_pending = true;

    // ìƒíƒœ í™•ì¸ ìš”ì²­ì„ ì¼ì • ì‹œê°„ ë’¤ì— ìˆ˜í–‰í•˜ë„ë¡ íƒ€ì´ë¨¸ ì¶”ê°€
    lv_timer_create(request_fan_status, 300, NULL);  // 300ms í›„ ìƒíƒœ í™•ì¸
}


void request_smog_status(lv_timer_t * timer) {
    if (millis() - smog_last_request >= 100 && smog_request_pending) {
        Wire.requestFrom(SLAVE_ADDR, 1);  // ìŠ¬ë ˆì´ë¸Œì—ì„œ ìŠ¤ëª¨ê·¸ ìƒíƒœ ìš”ì²­
        if (Wire.available()) {
            char smog_state = Wire.read();
            lv_label_set_text(ui_humidifier, (smog_state == '1') ? "Smog ON" : "Smog OFF");
            Serial.print("ìŠ¤ëª¨ê·¸ ìƒíƒœ ì—…ë°ì´íŠ¸: ");
            Serial.println(smog_state == '1' ? "ON" : "OFF");
        }
        smog_request_pending = false;  // ìš”ì²­ ì™„ë£Œ
    }
}

void toggle_smog(lv_event_t * e)
{
	Serial.println("ê°€ìŠµê¸° í† ê¸€ ëª…ë ¹ ì „ì†¡...");
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write('H');  // 'H' (Humidifier Toggle) ëª…ë ¹ ì „ì†¡
    Wire.endTransmission();
    
    smog_last_request = millis();  // ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê°„ ê¸°ë¡
    smog_request_pending = true;  // ê°€ìŠµê¸° ìƒíƒœ ìš”ì²­ ì˜ˆì•½
}

void request_led_status(lv_timer_t * timer) {
    if (millis() - led_last_request >= 100 && led_request_pending) {
        Wire.requestFrom(SLAVE_ADDR, 1);  // ìŠ¬ë ˆì´ë¸Œì—ì„œ LED ìƒíƒœ ìš”ì²­
        if (Wire.available()) {
            char led_state = Wire.read();
            lv_label_set_text(ui_led, (led_state == '1') ? "LED ON" : "LED OFF");
            Serial.print("LED ìƒíƒœ ì—…ë°ì´íŠ¸: ");
            Serial.println(led_state == '1' ? "ON" : "OFF");
        }
        led_request_pending = false;  // ìš”ì²­ ì™„ë£Œ
    }
}


void toggle_led(lv_event_t * e)
{
	Serial.println("LED í† ê¸€ ëª…ë ¹ ì „ì†¡...");
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write('L');  // 'L' (LED Toggle) ëª…ë ¹ ì „ì†¡
    Wire.endTransmission();
    
    led_last_request = millis();  // ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê°„ ê¸°ë¡
    led_request_pending = true;  // LED ìƒíƒœ ìš”ì²­ ì˜ˆì•½
}


void send_data_to_raspberry() {
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("WiFi ì—°ê²° ì•ˆ ë¨.");
        return;
    }

    WiFiClient client;
    if (!client.connect(SERVER_IP, 5000)) {
        Serial.println("ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ì‹¤íŒ¨.");
        return;
    }

    Serial.println("ë¼ì¦ˆë² ë¦¬íŒŒì´ì™€ ì—°ê²°ë¨. ë°ì´í„° ì „ì†¡ ì‹œì‘...");
    File file = SD.open("/heartDATA/heart_data.txt");

    if (!file) {
        Serial.println("íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨.");
        client.stop();
        return;
    }

    while (file.available()) {
        uint8_t buffer[512];
        size_t bytesRead = file.read(buffer, sizeof(buffer));
        client.write(buffer, bytesRead);  // ë°ì´í„° íŒ¨í‚· ë‹¨ìœ„ ì „ì†¡
    }

    file.close();
    client.stop();
    Serial.println("ë°ì´í„° ì „ì†¡ ì™„ë£Œ.");
}



void save_heart_data(float bpm) {
    if (!SD.exists("/heartDATA")) {
        SD.mkdir("/heartDATA");
    }
    heartDataFile = SD.open("/heartDATA/heart_data.txt", FILE_APPEND);
    if (heartDataFile) {
        heartDataFile.print(millis());
        heartDataFile.print(", ");
        heartDataFile.println(bpm);
        heartDataFile.close();
    }
}


void HeartBeatMeasuringStart(lv_event_t * e)
{
    Serial.println("HeartMeasuring í™”ë©´ ë¡œë“œë¨, 'Touch Plz' í‘œì‹œ.");
    lv_label_set_text(ui_Measuring, "Touch Plz");

    start_time = millis();
    is_measuring = false;
}

void measure_heart_rate(lv_timer_t * timer) {
    if (millis() - start_time >= 5000) {  // 5ì´ˆ ê²½ê³¼ ì‹œ ì¸¡ì • ì¢…ë£Œ
        Serial.println("ì‹¬ë°•ìˆ˜ ì¸¡ì • ì™„ë£Œ.");
        lv_label_set_text(ui_Measuring, "Finish!");
        lv_timer_del(timer);
        send_data_to_raspberry();
        is_measuring = false;
        return;
    }

    float heartRate = heartRateSensor.getHeartRate();
    if (!isnan(heartRate) && heartRate > 0) {
        Serial.print("ì‹¬ë°•ìˆ˜: ");
        Serial.println(heartRate);
        save_heart_data(heartRate);
    }
}

void check_sensor_data(lv_timer_t * timer) {
    float heartRate = heartRateSensor.getHeartRate();
    if (!isnan(heartRate) && heartRate > 0 && !is_measuring) {
        Serial.println("ì‹¬ë°•ìˆ˜ ë°ì´í„° ê°ì§€ë¨. ì¸¡ì • ì‹œì‘!");
        lv_label_set_text(ui_Measuring, "Measuring...");
        is_measuring = true;
        start_time = millis();
        lv_timer_create(measure_heart_rate, 500, NULL);
    }
}


//bluetooth connect code

void start_bluetooth_status(lv_timer_t * timer)  
{
	static int retry_count = 0;

	if (SerialBT.hasClient()) {
		Serial.println("ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì„±ê³µ!");
		lv_label_set_text(ui_bluetoothLabel, "Connect Success!");
		lv_timer_del(bt_timer);
	} else {
		retry_count++;
		if (retry_count < 10) {  // ìµœëŒ€ 10íšŒ ì¬ì‹œë„
			Serial.println("ë¸”ë£¨íˆ¬ìŠ¤ ì¬ì‹œë„ ì¤‘...");
		} else {
			Serial.println("ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹¤íŒ¨!");
			lv_label_set_text(ui_bluetoothLabel, "Connect Fail!");
			lv_timer_del(bt_timer);
		}
	}
}


void start_bluetooth_connection(lv_event_t * e){
	Serial.print("ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹œë„...");
	lv_label_set_text(ui_bluetoothLabel, "Connecting...")
	
	bt_start_time = millis();
	bt_timer = lv_timer_create(start_bluetooth_status, 100, NULL);
}

void play_touch_sound() {
    File audioFile = SD.open("/touch.wav");
    if (!audioFile) {
        Serial.println("âŒ í„°ì¹˜ ì‚¬ìš´ë“œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        return;
    }

    Serial.println("ğŸ”Š í„°ì¹˜ ì‚¬ìš´ë“œ ì¬ìƒ ì‹œì‘");
    
    // I2Së¥¼ í†µí•œ ì˜¤ë””ì˜¤ ì¬ìƒ
    size_t bytesWritten = 0;
    uint8_t buffer[1024];
    while (audioFile.available()) {
        size_t bytesRead = audioFile.read(buffer, sizeof(buffer));
        i2s_write(I2S_NUM_0, buffer, bytesRead, &bytesWritten, portMAX_DELAY);
    }
    
    audioFile.close();
    Serial.println("âœ… í„°ì¹˜ ì‚¬ìš´ë“œ ì¬ìƒ ì™„ë£Œ");
}

// ëª¨ë“  ë²„íŠ¼ì˜ ê³µí†µ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
void common_button_event_handler(lv_event_t * e) {
    lv_event_code_t code = lv_event_get_code(e);
    if(code == LV_EVENT_CLICKED) {
        play_touch_sound();
    }
}

void on_button_pressed(lv_event_t * e) {
    Serial.println("ğŸ–² ë²„íŠ¼ í„°ì¹˜ë¨, íš¨ê³¼ìŒ ì‹¤í–‰!");
    play_touch_sound();  // ğŸ”Š íš¨ê³¼ìŒ ì¬ìƒ
}

void hide_home_button(lv_event_t * e)
{
	// Your code here
}

void update_temp_hum(lv_timer_t * timer) {
    float temp = dht.readTemperature();
    float hum = dht.readHumidity();

    if (!isnan(temp) && !isnan(hum)) {  // ìœ íš¨í•œ ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ UI ì—…ë°ì´íŠ¸
        static char temp_text[16];
        static char hum_text[16];
        sprintf(temp_text, "%.1f Â°C", temp);
        sprintf(hum_text, "%.1f %%", hum);

        lv_label_set_text(ui_tempData, temp_text);
        lv_label_set_text(ui_humData, hum_text);
        lv_bar_set_value(ui_tempBar, (int)temp, LV_ANIM_ON);
        lv_bar_set_value(ui_humBar, (int)hum, LV_ANIM_ON);

        Serial.print("ì˜¨ë„: ");
        Serial.print(temp);
        Serial.print(" Â°C, ìŠµë„: ");
        Serial.print(hum);
        Serial.println(" %");
    }
}

void update_Sensor_Data(lv_event_t * e)
{
    Serial.println("í™ˆ í™”ë©´ ë¡œë“œ ì™„ë£Œ - ì˜¨ìŠµë„ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...");
    dht.begin();
    lv_timer_create(update_temp_hum, 2000, NULL);
}


//ì£¼ì˜ ì‚¬í•­*
//humidifierì€ label ui, smogëŠ” event ì´ë¦„ìœ¼ë¡œ í˜¼ë™ì˜ ìš”ì†Œê°€ ê°•í•¨


// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.5.0
// LVGL version: 9.1.0
// Project name: SquareLine_Project_change

#include "ui.h"
#include "lvgl.h"
#include "ui_events.h"
#include "BluetoothSerial.h"
#include "Wire.h"
#include "DHT.h"
#include "Adafruit_MAX30102.h"
#include "WiFi.h"
#include "FS.h"
#include "SD.h"
#include "SPI.h"
#include "driver/i2s.h"

#define SD_CS 13  // SD ì¹´ë“œ ì¹© ì…€ë ‰íŠ¸ í•€
#define WIFI_SSID "YOUR_WIFI_SSID"
#define WIFI_PASSWORD "YOUR_WIFI_PASSWORD"
#define SERVER_IP "192.168.1.100"  // ë¼ì¦ˆë² ë¦¬íŒŒì´ IP
#define DHT_PIN 4
#define DHT_TYPE DHT22
#define SLAVE_ADDR 0x08
#define I2S_NUM I2S_NUM_0
#define MUSIC_FILE_PATH "/music.wav"

DHT dht(DHT_PIN, DHT_TYPE);
Adafruit_MAX30102 heartRateSensor;
bool is_measuring = false;
unsigned long start_time = 0;
File heartDataFile;
File musicFile;
bool isPlaying = false;
extern BluetoothSerial SerialBT; //ë¸”ë£¨íˆ¬ìŠ¤ ê°ì²´

//ë¼ì¦ˆë² ë¦¬íŒŒì´ì— ë°ì´í„° ì „ì†¡í•˜ëŠ” ë‚´ìš©



//ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸ìš© íƒ€ì´ë¨¸ í•¸ë“¤ëŸ¬

lv_timer_t * bt_timer= NULL;
unsigned long bt_start_time = 0; //bluetooth for millis

//fan toggle millis êµ¬ì¡°

unsigned long fan_last_request = 0;
bool fan_request_pending = false;

//led toggle millis

unsigned long led_last_request = 0;
bool led_request_pending = false;

//smog toggle millis
unsigned long smog_last_request = 0;
bool smog_request_pending = false;

void request_fan_status(lv_timer_t * timer) {
    if (fan_request_pending && millis() - fan_last_request >= 100) {
        Wire.requestFrom(SLAVE_ADDR, 1);  
        unsigned long start_wait = millis();
        while (!Wire.available() && millis() - start_wait < 50);  // ìµœëŒ€ 50ms ëŒ€ê¸°

        if (Wire.available()) {
            char fan_state = Wire.read();
            lv_label_set_text(ui_fan, (fan_state == '1') ? "Fan ON" : "Fan OFF");
            Serial.print("íŒ¬ ìƒíƒœ ì—…ë°ì´íŠ¸: ");
            Serial.println(fan_state == '1' ? "ON" : "OFF");
        } else {
            Serial.println("íŒ¬ ìƒíƒœ ìš”ì²­ ì‹¤íŒ¨: ì‘ë‹µ ì—†ìŒ.");
        }

        fan_request_pending = false;
    }
}

void fan_toggle(lv_event_t * e)
{
    Serial.println("íŒ¬ í† ê¸€ ëª…ë ¹ ì „ì†¡...");
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write('T');
    Wire.endTransmission();

    fan_last_request = millis();  
    fan_request_pending = true;

    // ìƒíƒœ í™•ì¸ ìš”ì²­ì„ ì¼ì • ì‹œê°„ ë’¤ì— ìˆ˜í–‰í•˜ë„ë¡ íƒ€ì´ë¨¸ ì¶”ê°€
    lv_timer_create(request_fan_status, 300, NULL);  // 300ms í›„ ìƒíƒœ í™•ì¸
}


void request_smog_status(lv_timer_t * timer) {
    if (millis() - smog_last_request >= 100 && smog_request_pending) {
        Wire.requestFrom(SLAVE_ADDR, 1);  // ìŠ¬ë ˆì´ë¸Œì—ì„œ ìŠ¤ëª¨ê·¸ ìƒíƒœ ìš”ì²­
        if (Wire.available()) {
            char smog_state = Wire.read();
            lv_label_set_text(ui_humidifier, (smog_state == '1') ? "Smog ON" : "Smog OFF");
            Serial.print("ìŠ¤ëª¨ê·¸ ìƒíƒœ ì—…ë°ì´íŠ¸: ");
            Serial.println(smog_state == '1' ? "ON" : "OFF");
        }
        smog_request_pending = false;  // ìš”ì²­ ì™„ë£Œ
    }
}

void toggle_smog(lv_event_t * e)
{
	Serial.println("ê°€ìŠµê¸° í† ê¸€ ëª…ë ¹ ì „ì†¡...");
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write('H');  // 'H' (Humidifier Toggle) ëª…ë ¹ ì „ì†¡
    Wire.endTransmission();
    
    smog_last_request = millis();  // ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê°„ ê¸°ë¡
    smog_request_pending = true;  // ê°€ìŠµê¸° ìƒíƒœ ìš”ì²­ ì˜ˆì•½
}

void request_led_status(lv_timer_t * timer) {
    if (millis() - led_last_request >= 100 && led_request_pending) {
        Wire.requestFrom(SLAVE_ADDR, 1);  // ìŠ¬ë ˆì´ë¸Œì—ì„œ LED ìƒíƒœ ìš”ì²­
        if (Wire.available()) {
            char led_state = Wire.read();
            lv_label_set_text(ui_led, (led_state == '1') ? "LED ON" : "LED OFF");
            Serial.print("LED ìƒíƒœ ì—…ë°ì´íŠ¸: ");
            Serial.println(led_state == '1' ? "ON" : "OFF");
        }
        led_request_pending = false;  // ìš”ì²­ ì™„ë£Œ
    }
}


void toggle_led(lv_event_t * e)
{
	Serial.println("LED í† ê¸€ ëª…ë ¹ ì „ì†¡...");
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write('L');  // 'L' (LED Toggle) ëª…ë ¹ ì „ì†¡
    Wire.endTransmission();
    
    led_last_request = millis();  // ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê°„ ê¸°ë¡
    led_request_pending = true;  // LED ìƒíƒœ ìš”ì²­ ì˜ˆì•½
}


void send_data_to_raspberry() {
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("WiFi ì—°ê²° ì•ˆ ë¨.");
        return;
    }

    WiFiClient client;
    if (!client.connect(SERVER_IP, 5000)) {
        Serial.println("ë¼ì¦ˆë² ë¦¬íŒŒì´ ì—°ê²° ì‹¤íŒ¨.");
        return;
    }

    Serial.println("ë¼ì¦ˆë² ë¦¬íŒŒì´ì™€ ì—°ê²°ë¨. ë°ì´í„° ì „ì†¡ ì‹œì‘...");
    File file = SD.open("/heartDATA/heart_data.txt");

    if (!file) {
        Serial.println("íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨.");
        client.stop();
        return;
    }

    while (file.available()) {
        uint8_t buffer[512];
        size_t bytesRead = file.read(buffer, sizeof(buffer));
        client.write(buffer, bytesRead);  // ë°ì´í„° íŒ¨í‚· ë‹¨ìœ„ ì „ì†¡
    }

    file.close();
    client.stop();
    Serial.println("ë°ì´í„° ì „ì†¡ ì™„ë£Œ.");
}



void save_heart_data(float bpm) {
    if (!SD.exists("/heartDATA")) {
        SD.mkdir("/heartDATA");
    }
    heartDataFile = SD.open("/heartDATA/heart_data.txt", FILE_APPEND);
    if (heartDataFile) {
        heartDataFile.print(millis());
        heartDataFile.print(", ");
        heartDataFile.println(bpm);
        heartDataFile.close();
    }
}


void ui_event_start_measuring(lv_event_t * e) {
    lv_obj_t * target = lv_event_get_target(e);
    if (lv_event_get_code(e) == LV_EVENT_CLICKED) {
        // ì¸¡ì • ì‹œì‘ ì‹œ UI ì—…ë°ì´íŠ¸
        lv_label_set_text(ui_Measuring, "ì¸¡ì • ì¤‘...");
        
        // ì¸¡ì • íƒ€ì´ë¨¸ ì‹œì‘ (5ì´ˆ)
        static lv_timer_t * measure_timer = NULL;
        if (measure_timer == NULL) {
            measure_timer = lv_timer_create(measure_heart_rate, 100, NULL);
            lv_timer_set_repeat_count(measure_timer, 50); // 5ì´ˆ (50 * 100ms)
        }
    }
}

// ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
static uint32_t red_buffer[100];
static uint32_t ir_buffer[100];
static uint8_t buffer_index = 0;
static bool measuring = false;
static int32_t heart_rate = 0;
static int32_t spo2_value = 0;

void measure_heart_rate(lv_timer_t * timer) {
    static int progress = 0;
    
    if (progress == 0) {
        // ì¸¡ì • ì‹œì‘ ì‹œ ì´ˆê¸°í™”
        buffer_index = 0;
        measuring = true;
        particleSensor.setup(60, 4, 2, 411, 4096);
    }
    
    if (measuring && buffer_index < 100) {
        // ì„¼ì„œì—ì„œ ë°ì´í„° ì½ê¸°
        while (particleSensor.available()) {
            red_buffer[buffer_index] = particleSensor.getRed();
            ir_buffer[buffer_index] = particleSensor.getIR();
            particleSensor.nextSample();
            
            buffer_index++;
            if (buffer_index >= 100) break;
        }
    }
    
    progress += 2; // 2% ì¦ê°€
    char progress_text[32];
    snprintf(progress_text, sizeof(progress_text), "ì¸¡ì • ì¤‘... %d%%", progress);
    lv_label_set_text(ui_Measuring, progress_text);
    
    if (progress >= 100) {
        // ì¸¡ì • ì™„ë£Œ
        measuring = false;
        int8_t valid_spo2, valid_hr;
        maxim_heart_rate_and_oxygen_saturation(ir_buffer, 100, red_buffer, &spo2_value, &valid_spo2, &heart_rate, &valid_hr);
        
        char result_text[64];
        if (valid_hr && valid_spo2) {
            snprintf(result_text, sizeof(result_text), "ì‹¬ë°•ìˆ˜: %ld bpm\nSpO2: %ld%%", heart_rate, spo2_value);
            
            // SD ì¹´ë“œì— ë°ì´í„° ì €ì¥
            save_measurement_data(heart_rate, spo2_value);
        } else {
            snprintf(result_text, sizeof(result_text), "ì¸¡ì • ì‹¤íŒ¨\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”");
        }
        
        lv_label_set_text(ui_HeartResult, result_text);
        lv_label_set_text(ui_Measuring, "í„°ì¹˜í•˜ì—¬ ì¸¡ì • ì‹œì‘");
        
        // íƒ€ì´ë¨¸ ì •ë¦¬
        lv_timer_del(timer);
    }
}

void save_measurement_data(int32_t hr, int32_t spo2) {
    File dataFile = SD.open("/measurements.csv", FILE_APPEND);
    if (dataFile) {
        char timestamp[20];
        time_t now;
        time(&now);
        strftime(timestamp, sizeof(timestamp), "%Y-%m-%d %H:%M:%S", localtime(&now));
        
        char data_line[64];
        snprintf(data_line, sizeof(data_line), "%s,%ld,%ld\n", timestamp, hr, spo2);
        dataFile.print(data_line);
        dataFile.close();
    }
}

void HeartBeatMeasuringStart(lv_event_t * e)
{
    Serial.println("HeartMeasuring í™”ë©´ ë¡œë“œë¨, 'Touch Plz' í‘œì‹œ.");
    lv_label_set_text(ui_Measuring, "Touch Plz");

    start_time = millis();
    is_measuring = false;
}

void check_sensor_data(lv_timer_t * timer) {
    float heartRate = heartRateSensor.getHeartRate();
    if (!isnan(heartRate) && heartRate > 0 && !is_measuring) {
        Serial.println("ì‹¬ë°•ìˆ˜ ë°ì´í„° ê°ì§€ë¨. ì¸¡ì • ì‹œì‘!");
        lv_label_set_text(ui_Measuring, "Measuring...");
        is_measuring = true;
        start_time = millis();
        lv_timer_create(measure_heart_rate, 500, NULL);
    }
}


//bluetooth connect code

void start_bluetooth_status(lv_timer_t * timer)  
{
	static int retry_count = 0;

	if (SerialBT.hasClient()) {
		Serial.println("ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì„±ê³µ!");
		lv_label_set_text(ui_bluetoothLabel, "Connect Success!");
		lv_timer_del(bt_timer);
	} else {
		retry_count++;
		if (retry_count < 10) {  // ìµœëŒ€ 10íšŒ ì¬ì‹œë„
			Serial.println("ë¸”ë£¨íˆ¬ìŠ¤ ì¬ì‹œë„ ì¤‘...");
		} else {
			Serial.println("ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹¤íŒ¨!");
			lv_label_set_text(ui_bluetoothLabel, "Connect Fail!");
			lv_timer_del(bt_timer);
		}
	}
}


void start_bluetooth_connection(lv_event_t * e){
	Serial.print("ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹œë„...");
	lv_label_set_text(ui_bluetoothLabel, "Connecting...")
	
	bt_start_time = millis();
	bt_timer = lv_timer_create(start_bluetooth_status, 100, NULL);
}

void play_touch_sound() {
    File audioFile = SD.open(AUDIO_FILE_PATH);  // íš¨ê³¼ìŒ íŒŒì¼ ì—´ê¸°
    if (!audioFile) {
        Serial.println("âŒ íš¨ê³¼ìŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        return;
    }

    Serial.println("ğŸ”Š íš¨ê³¼ìŒ ì¬ìƒ ì‹œì‘...");

    uint8_t buffer[1024];
    while (audioFile.available()) {
        size_t bytesRead = audioFile.read(buffer, sizeof(buffer));
        i2s_write(I2S_NUM, buffer, bytesRead, NULL, portMAX_DELAY);
    }

    audioFile.close();
    Serial.println("âœ… íš¨ê³¼ìŒ ì¬ìƒ ì™„ë£Œ.");
}

void on_button_pressed(lv_event_t * e) {
    Serial.println("ğŸ–² ë²„íŠ¼ í„°ì¹˜ë¨, íš¨ê³¼ìŒ ì‹¤í–‰!");
    play_touch_sound();  // ğŸ”Š íš¨ê³¼ìŒ ì¬ìƒ
}

void hide_home_button(lv_event_t * e)
{
	// Your code here
}

void update_temp_hum(lv_timer_t * timer) {
    float temp = dht.readTemperature();
    float hum = dht.readHumidity();

    if (!isnan(temp) && !isnan(hum)) {  // ìœ íš¨í•œ ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ UI ì—…ë°ì´íŠ¸
        static char temp_text[16];
        static char hum_text[16];
        sprintf(temp_text, "%.1f Â°C", temp);
        sprintf(hum_text, "%.1f %%", hum);

        lv_label_set_text(ui_tempData, temp_text);
        lv_label_set_text(ui_humData, hum_text);
        lv_bar_set_value(ui_tempBar, (int)temp, LV_ANIM_ON);
        lv_bar_set_value(ui_humBar, (int)hum, LV_ANIM_ON);

        Serial.print("ì˜¨ë„: ");
        Serial.print(temp);
        Serial.print(" Â°C, ìŠµë„: ");
        Serial.print(hum);
        Serial.println(" %");
    }
}

void update_Sensor_Data(lv_event_t * e)
{
    Serial.println("í™ˆ í™”ë©´ ë¡œë“œ ì™„ë£Œ - ì˜¨ìŠµë„ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...");
    dht.begin();
    lv_timer_create(update_temp_hum, 2000, NULL);
}

// ë¦´ë ˆì´ ì œì–´ë¥¼ ìœ„í•œ ëª…ë ¹ì–´ ì •ì˜
#define CMD_FAN_ON    'F'
#define CMD_FAN_OFF   'f'
#define CMD_LED_ON    'L'
#define CMD_LED_OFF   'l'
#define CMD_HUM_ON    'H'
#define CMD_HUM_OFF   'h'

// ë¦´ë ˆì´ ìƒíƒœ ë³€ìˆ˜
static bool fan_state = false;
static bool led_state = false;
static bool hum_state = false;

void ui_event_ControlLeftDown(lv_event_t * e) {
    lv_event_code_t event_code = lv_event_get_code(e);
    if(event_code == LV_EVENT_CLICKED) {
        // íŒ¬ ì œì–´ ëª…ë ¹ ì „ì†¡
        fan_state = !fan_state;
        sendCommand(fan_state ? CMD_FAN_ON : CMD_FAN_OFF);
        fan_request_pending = true;
        fan_last_request = millis();
        
        // ìƒíƒœ í™•ì¸ íƒ€ì´ë¨¸ ì‹œì‘ (ì—†ìœ¼ë©´ ìƒì„±)
        static lv_timer_t * fan_timer = NULL;
        if (fan_timer == NULL) {
            fan_timer = lv_timer_create(request_fan_status, 100, NULL);
        }
    }
}

void request_fan_status(lv_timer_t * timer) {
    if (fan_request_pending && millis() - fan_last_request >= 100) {
        Wire.requestFrom(SLAVE_ADDR, 1);
        if (Wire.available()) {
            byte status = Wire.read();
            bool actual_fan_state = (status & 0x0C) != 0;
            
            // UI ì—…ë°ì´íŠ¸
            static lv_style_t style_pressed;
            lv_style_init(&style_pressed);
            lv_style_set_img_recolor_opa(&style_pressed, 255);
            lv_style_set_img_recolor(&style_pressed, actual_fan_state ? lv_color_hex(0x00FF00) : lv_color_hex(0x808080));
            
            lv_obj_add_style(ui_ControlLeftDown, &style_pressed, 0);
            
            // ìƒíƒœê°€ í™•ì¸ë˜ë©´ pending í”Œë˜ê·¸ í•´ì œ
            fan_request_pending = false;
            
            // íƒ€ì´ë¨¸ ì‚­ì œ
            lv_timer_del(timer);
        }
    }
}

void ui_event_ControlRightDown(lv_event_t * e) {
    lv_event_code_t event_code = lv_event_get_code(e);
    if(event_code == LV_EVENT_CLICKED) {
        // LED ì œì–´ ëª…ë ¹ ì „ì†¡
        led_state = !led_state;
        sendCommand(led_state ? CMD_LED_ON : CMD_LED_OFF);
        led_request_pending = true;
        led_last_request = millis();
        
        // ìƒíƒœ í™•ì¸ íƒ€ì´ë¨¸ ì‹œì‘ (ì—†ìœ¼ë©´ ìƒì„±)
        static lv_timer_t * led_timer = NULL;
        if (led_timer == NULL) {
            led_timer = lv_timer_create(request_led_status, 100, NULL);
        }
    }
}

void request_led_status(lv_timer_t * timer) {
    if (led_request_pending && millis() - led_last_request >= 100) {
        Wire.requestFrom(SLAVE_ADDR, 1);
        if (Wire.available()) {
            byte status = Wire.read();
            bool actual_led_state = (status & 0xF0) != 0;
            
            // UI ì—…ë°ì´íŠ¸
            static lv_style_t style_pressed;
            lv_style_init(&style_pressed);
            lv_style_set_img_recolor_opa(&style_pressed, 255);
            lv_style_set_img_recolor(&style_pressed, actual_led_state ? lv_color_hex(0x00FF00) : lv_color_hex(0x808080));
            
            lv_obj_add_style(ui_ControlRightDown, &style_pressed, 0);
            
            // ìƒíƒœê°€ í™•ì¸ë˜ë©´ pending í”Œë˜ê·¸ í•´ì œ
            led_request_pending = false;
            
            // íƒ€ì´ë¨¸ ì‚­ì œ
            lv_timer_del(timer);
        }
    }
}

void ui_event_ControlRightUp(lv_event_t * e) {
    lv_event_code_t event_code = lv_event_get_code(e);
    if(event_code == LV_EVENT_CLICKED) {
        // ê°€ìŠµê¸° ì œì–´ ëª…ë ¹ ì „ì†¡
        hum_state = !hum_state;
        sendCommand(hum_state ? CMD_HUM_ON : CMD_HUM_OFF);
        hum_request_pending = true;
        hum_last_request = millis();
        
        // ìƒíƒœ í™•ì¸ íƒ€ì´ë¨¸ ì‹œì‘ (ì—†ìœ¼ë©´ ìƒì„±)
        static lv_timer_t * hum_timer = NULL;
        if (hum_timer == NULL) {
            hum_timer = lv_timer_create(request_hum_status, 100, NULL);
        }
    }
}

void request_hum_status(lv_timer_t * timer) {
    if (hum_request_pending && millis() - hum_last_request >= 100) {
        Wire.requestFrom(SLAVE_ADDR, 1);
        if (Wire.available()) {
            byte status = Wire.read();
            bool actual_hum_state = (status & 0x03) != 0;
            
            // UI ì—…ë°ì´íŠ¸
            static lv_style_t style_pressed;
            lv_style_init(&style_pressed);
            lv_style_set_img_recolor_opa(&style_pressed, 255);
            lv_style_set_img_recolor(&style_pressed, actual_hum_state ? lv_color_hex(0x00FF00) : lv_color_hex(0x808080));
            
            lv_obj_add_style(ui_ControlRightUp, &style_pressed, 0);
            
            // ìƒíƒœê°€ í™•ì¸ë˜ë©´ pending í”Œë˜ê·¸ í•´ì œ
            hum_request_pending = false;
            
            // íƒ€ì´ë¨¸ ì‚­ì œ
            lv_timer_del(timer);
        }
    }
}

// I2Cub97c ud1b5ud574 Arduinouc5d0 uba85ub839 uc804uc1a1
void sendCommand(char command) {
    Wire.beginTransmission(SLAVE_ADDR);
    Wire.write(command);
    Wire.endTransmission();
    
    // ub514ubc84uae45uc6a9 ub85cuadf8
    Serial.print("Command sent: ");
    Serial.println(command);
}

// íƒ€ì´ë¨¸ ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€
static lv_timer_t * fan_timer = NULL;
static lv_timer_t * led_timer = NULL;
static lv_timer_t * hum_timer = NULL;

void ui_event_ControlLeftUp(lv_event_t * e) {
    lv_event_code_t event_code = lv_event_get_code(e);
    if(event_code == LV_EVENT_CLICKED) {
        // ë’¤ë¡œê°€ê¸°
        lv_disp_t * d = lv_disp_get_default();
        lv_screen_load_anim(ui_home, LV_SCR_LOAD_ANIM_MOVE_LEFT, 150, 0, false);
    }
}

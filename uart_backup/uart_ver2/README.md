# ESP32와 Arduino R4 UART 통신 프로젝트

## 버전 정보

### 버전 1.1.5 (2025-03-31)

MAX30102 심박수/산소포화도 센서 데이터 처리 로직을 완전히 개선했습니다. 사용자 요구사항에 따라 코드 변경사항을 펌웨어 버전처럼 기록했습니다. ESP32-WROOM-32에서 MAX30102 심박수/산소포화도 센서의 사용을 중단하고, 산소포화도 측정 기능을 제거했습니다.

- 사용자 요구사항에 따라 산소포화도 측정 기능을 제거
- 코드 변경사항을 펌웨어 버전처럼 기록
- ESP32-WROOM-32에서 MAX30102 심박수/산소포화도 센서의 사용을 중단

### 버전 1.1.4 (2025-03-31)

MAX30102 심박수/산소포화도 센서 데이터 처리 로직을 완전히 개선했습니다. 기존의 복잡한 로직을 단순화하고 보다 직관적인 방식으로 센서 데이터를 읽고 처리하도록 변경했습니다.

- 센서 데이터 디버깅을 위해 IR 및 RED 값 출력 추가
- checkForBeat() 함수를 사용하여 보다 신뢰성 있는 심박 감지 구현
- 심박수 계산 방식 개선 (30BPM ~ 220BPM 범위로 제한)
- 산소포화도 계산 방식 개선 (90%~100% 범위로 제한)
- 심박 감지 시 "Beat!" 메시지 표시로 실시간 피드백 제공
- 시리얼 출력 형식 개선으로 가독성 향상

### 버전 1.1.3 (2025-03-31)

MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경한 내용을 업데이트합니다. MAX30102 심박수/산소포화도 센서의 LED 전류를 31.25mA로 설정하고, 샘플링 속도를 400Hz로 변경하였습니다. 또한, IR 센서의 감지 거리를 7000mm로 설정하였습니다. 온도 데이터의 처리를 위한 변수명 변경 (temp→tempValue) 및 ESP32의 watchdog 타이머를 설정하였습니다. 마지막으로, 센서 데이터의 전송을 위한 함수를 추가하였습니다.

- 릴레이 제어 기능 (팬, LED, 가습기)
- 센서 데이터 송수신 (온도, 습도, 심박수, 산소포화도)
- 명령어 기반 통신 프로토콜
- 디버깅을 위한 시리얼 모니터 출력
- I2C 센서 연결 기능 (v1.1.0)

### 버전 1.1.2 (2025-03-31)

MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경한 내용을 업데이트합니다. MAX30102 심박수/산소포화도 센서의 샘플링 속도를 400Hz로 변경하였습니다. 또한, 온도 데이터의 처리를 위한 변수명 변경 (temp→tempValue) 및 ESP32의 watchdog 타이머를 설정하였습니다.

- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 업데이트 (SparkFunMAX3010x, Adafruit_SHT31)
- I2C 속도를 50kHz에서 100kHz로 변경
- 센서 데이터 처리를 위한 변수명 변경 (heartRate→heartRateValue, spo2→spo2Value)
- I2C 버스 상태 확인을 위한 i2cBusy 변수 추가

### 버전 1.1.1 (2025-03-31)

ESP32에 I2C 센서 연결 기능을 추가한 내용을 업데이트 합니다.

## 주요 기능

1. ESP32와 Arduino R4 간 UART 통신 구현
2. 릴레이 제어 기능 (팬, LED, 가습기)
3. 센서 데이터 송수신 (온도, 습도, 심박수)
4. 명령어 기반 통신 프로토콜
5. 디버깅을 위한 시리얼 모니터 출력
6. I2C 센서 연결 기능 (v1.1.0)

## 하드웨어 연결

### ESP32 연결
- UART2 사용: RX(GPIO16), TX(GPIO17)
- I2C 연결: SDA(GPIO21), SCL(GPIO22)
- 디버깅용 USB 시리얼 포트는 별도로 사용 가능 (UART0)

### I2C 센서 연결
- MAX30102 심박수/산소포화도 센서: 0x57
- SHT31 온습도 센서: 0x44

### Arduino R4 연결
- Serial1 사용: RX(핀 0), TX(핀 1)
- 릴레이 제어: 팬(D2), LED(D3), 가습기(D4)
- 센서 연결: 온도(A0), 습도(A1) - 테스트용 더미 값 생성

## 통신 프로토콜

### 명령어 정의
- F: 팬 켜기
- f: 팬 끄기
- L: LED 켜기
- l: LED 끄기
- H: 가습기 켜기
- h: 가습기 끄기
- S: 모든 릴레이 상태 요청
- T: 온도 데이터 요청
- U: 습도 데이터 요청

### 데이터 형식
- 명령: 단일 문자 (\n으로 종료)
- 응답: "키:값" 형식 (\n으로 종료)
  - 예: "FAN:ON", "TEMP:23.5", "HUM_VAL:55.0"

## 사용 방법

### ESP32 제어
1. ESP32의 시리얼 모니터를 통해 다음 명령어로 릴레이 제어 가능:
   - 1: 팬 토글
   - 2: LED 토글
   - 3: 가습기 토글
   - s: 상태 요청
   - t: 온도 요청
   - h: 습도 요청
   - ?: 도움말 표시

2. 센서 데이터는 5초마다 자동으로 업데이트됨

### Arduino R4
1. ESP32로부터 명령을 수신하여 릴레이 제어
2. 2초마다 자동으로 센서 데이터 업데이트 및 전송

## 장점

1. I2C 통신 문제 해결 - 더 안정적인 통신 방식
2. 디버깅이 용이함 - ESP32에서 UART0와 UART2를 동시에 사용 가능
3. 명확한 명령어 기반 프로토콜 구현
4. 양방향 통신 용이
5. I2C 센서 연결 기능 추가 (v1.1.0)

## 변경 이력

### 버전 1.1.5 (2025-03-31)
- 사용자 요구사항에 따라 산소포화도 측정 기능을 제거했습니다.

### 버전 1.1.4 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 데이터 처리 로직을 완전히 개선했습니다.

### 버전 1.1.3 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경

### 버전 1.1.2 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경

### 버전 1.1.1 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 업데이트 (SparkFunMAX3010x, Adafruit_SHT31)
- I2C 속도를 50kHz에서 100kHz로 변경
- 센서 데이터 처리를 위한 변수명 변경 (heartRate→heartRateValue, spo2→spo2Value)
- I2C 버스 상태 확인을 위한 i2cBusy 변수 추가

### 버전 1.1.0 (2025-03-31)
- ESP32에 I2C 센서 연결 기능 추가
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원
- ESP32-WROOM-32의 제한을 고려하여 I2C 속도를 50kHz로 설정
- 다중 센서 데이터 처리를 위한 센서 스캔 기능 구현
- 센서 데이터 주기적 업데이트 기능 추가

### 버전 1.0.0 (2025-03-31)
- UART 통신으로 초기 마이그레이션
- ESP32에서 UART2(GPIO16/17) 사용
- Arduino R4에서 Serial1(핀 0/1) 사용
- 명령어 기반 통신 프로토콜 구현
- 릴레이 제어 및 센서 데이터 송수신 기능 구현

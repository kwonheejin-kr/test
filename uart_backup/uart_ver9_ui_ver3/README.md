# ESP32와 Arduino R4 UART 통신 프로젝트

## 버전 정보

### 버전 1.2.8 (2025-04-02)

심박수 표시 방식 개선

- MAX30102 센서 출력 형식 변경
  - 원시 센서 데이터(IR, RED) 표시 대신 계산된 심박수만 표시
  - "심박수: 75 BPM" 형식으로 단순하고 가독성 좋게 변경
  - 손가락이 감지되지 않을 때 메시지 간소화
- ESP32-WROOM-32 기능적 한계 고려
  - 심박수 처리 시 불필요한 출력 줄여 메모리 부하 감소
  - 시리얼 통신 부하 전체적 감소
  - UART 통신에 필요한 정보만 전달하도록 최적화

### 버전 1.2.7 (2025-04-02)

명령어 중복 문제 해결 및 설명서 업데이트

- 중복 명령어 문제 해결
  - 습도 요청 명령어를 'h'에서 'u'로 변경
  - 가습기 끄기 명령어 'h'와의 충돌 해결
  - printHelp() 함수의 명령어 설명 업데이트
- ESP32-WROOM-32 기능적 한계 고려
  - 명령어 처리의 유연성 향상
  - 코드 안정성 개선

### 버전 1.2.6 (2025-04-02)

MAX30102 심박수 센서 기능 개선

- MAX30102 심박수 센서 코드 전면 개선
  - 무한 재귀 호출 문제 해결 (readMAX30102이 자기 자신을 호출하는 문제)
  - IR 임계값을 50000에서 20000으로 낮춰 손가락 감지 성능 향상
  - checkForBeat() 함수를 활용한 신뢰성 있는 심박 인식 구현
  - 심박수 범위 제한 (30~220 BPM)
  - 4개 값의 평균을 활용한 심박수 안정화
- ESP32-WROOM-32 기능적 한계 고려
  - 심박이 없을 때 심박수를 바로 0으로 만들지 않고 점진적으로 감소시켜 리소스 활용 최적화
  - 디버깅 표시 개선 (심박 감지 하트 기호(♥) 추가)
  - 유효하지 않은 값 필터링 처리 개선

### 버전 1.2.5 (2025-04-02)

UART 통신을 통한 LED 제어 기능 개선

- ESP32에서 UART를 통한 직접 명령 전달 기능 추가
  - 직접 명령 전달 명령어(F,f,L,l,H,h)를 processSerialCommand()에 추가
  - 사용자가 시리얼 모니터를 통해 직접 명령 입력 가능
  - UART를 통해 Arduino로 즉시 명령 전달 가능
- 도움말 메시지 개선
  - 기존 명령어와 새 명령어를 구분하여 표시
  - 아두이노 직접 제어 명령어 섹션 추가
  - 한글 인코딩 문제 해결
- ESP32-WROOM-32의 기능적 한계를 고려한 최적화 유지

### 버전 1.2.4 (2025-04-01)

VL53LOX 센서 코드 Adafruit 예제 방식으로 단순화

- VL53LOX 센서 초기화 및 읽기 함수 단순화
  - 초기화 함수(initializeVL53LOX)에서 불필요한 디버그 메시지 제거
  - 초기 측정 테스트 제거
  - readVL53LOX() 함수 예제 코드 방식으로 단순화
- 인코딩 문제 해결
  - 한글 인코딩 문제 완전 해결
  - 시리얼 상태 메시지 정상 표시
- VCSEL 설정 값 최적화
  - 프리레인지 VCSEL 펄스: 18
  - 파이널레인지 VCSEL 펄스: 14

### 버전 1.2.3 (2025-04-01)

VL53LOX 센서 상태코드 처리 개선

- VL53LOX 센서 거리 측정 개선
  - 상태코드 2(신호 너무 강함)도 유효한 거리 데이터로 처리
  - `readVL53LOX()` 함수를 `measureDistance()`로 구조 개선
  - 거리 측정 이력 유지 및 대체 값 기능 제거
- 센서 상태 코드 출력 및 해석 개선
  - 모든 상태 코드에 대한 상세 설명 제공
  - 확장된 성공 조건(상태코드 0 또는 2)

### 버전 1.2.2 (2025-04-01)

VL53LOX 센서 VCSEL 펄스 기간 최적화

- VL53LOX 센서 성능 개선
  - VCSEL 펄스 기간 최적화 (프리레인지: 14, 파이널레인지: 10)
  - 레이저 출력 강도 조절로 신호 강도 문제 해결
  - ESP32-WROOM-32 기능적 한계를 고려한 최적화
- 측정 정확도와 안정성 향상

### 버전 1.2.1 (2025-04-01)

VL53LOX 센서 한글 문자 인코딩 문제 수정 및 코드 정리

- VL53LOX 센서 초기화 및 읽기 함수 개선
  - 한글 문자 인코딩 깨짐 문제 해결
  - 코드 구조 및 주석 정리
  - 에러 상태 코드 해석 기능 유지
  - ESP32-WROOM-32 기능적 한계를 고려한 최적화 유지
- 모든 한글 텍스트가 정상적으로 출력되도록 수정

### 버전 1.2.0 (2025-03-31)

VL53LOX 센서 초기화 개선 및 I2C 통신 속도 변경

- VL53LOX 센서 초기화 함수 개선
  - XSHUT 핀 설정 (GPIO 13 사용)
  - Adafruit VL53L0X 라이브러리 업데이트
  - begin() 함수 호출 시 true, true, VL53L0X_ADDRESS 매개변수 사용
  - I2C 통신 속도 50kHz로 설정
- VL53LOX 센서 초기화 함수 개선
  - setVcselPulsePeriod() 함수 사용
- 초기화 성공 시 기본 측정 테스트 구현

### 버전 1.1.9 (2025-03-31)

VL53LOX 센서 초기화 개선 및 I2C 통신 속도 변경

- I2C 통신 속도를 50kHz에서 100kHz로 다시 변경 (사용자 요청)
- VL53LOX 센서 초기화 함수 개선
  - begin() 함수 호출 전후 지연 시간(200ms) 추가
  - begin(false) 매개변수 추가하여 2.8V 모드 비활성화
  - 상세한 오류 메시지 및 문제 해결 방법 제공
- 초기화 성공 시 기본 측정 테스트 구현

### 버전 1.1.8 (2025-03-31)

ESP32-WROOM-32에서 I2C 통신 속도를 100kHz에서 50kHz로 변경하고, I2C 통신 안정성을 개선하기 위한 코드를 추가했습니다.

- I2C 통신 속도를 100kHz에서 50kHz로 변경 (ESP32-WROOM-32에서 테스트 결과 안정성 향상)
- I2C 통신 안정성을 위한 추가 코드 구현
- 안정성 테스트 결과에 따른 코드 최적화

### 버전 1.1.7 (2025-03-31)

VL53LOX Time-of-Flight 거리 센서의 고정된 측정값(2mm 및 상태코드 44) 문제 해결을 위한 코드 개선을 진행했습니다.

- VL53LOX 센서 초기화 함수 전체 개선
- I2C 통신 전/후 버스 상태 확인 코드 추가
- 더 상세한 상태 코드 해석 기능 추가 (0-8 상태 코드 의미 표시)
- 초기화 단계별 디버그 로그 추가
- Adafruit 라이브러리에 맞게 함수 호출 방식 개선 (setTimeout 제거 등)
- 센서 측정 시 오직 유효한 데이터(상태코드 0)만 처리하도록 수정

### 버전 1.1.6 (2025-03-31)

VL53LOX Time-of-Flight 거리 센서 데이터 처리 로직을 완전히 개선했습니다. 사용자 요구사항에 따라 코드 변경사항을 펌웨어 버전기록해두듯이 추가했습니다.

- 사용자 요구사항에 따라 2m 이내 거리 측정 기능을 제거
- 코드 변경사항을 펌웨어 버전처럼 기록
- ESP32-WROOM-32에서 VL53LOX 거리 센서의 사용을 중단

### 버전 1.1.5 (2025-03-31)

MAX30102 심박수/산소포화도 센서 데이터 처리 로직을 완전히 개선했습니다. 사용자 요구사항에 따라 코드 변경사항을 펌웨어 버전처럼 기록했습니다. ESP32-WROOM-32에서 MAX30102 심박수/산소포화도 센서의 사용을 중단하고, 산소포화도 측정 기능을 제거했습니다.

- 사용자 요구사항에 따라 산소포화도 측정 기능을 제거
- 코드 변경사항을 펌웨어 버전처럼 기록
- ESP32-WROOM-32에서 MAX30102 심박수/산소포화도 센서의 사용을 중단

### 버전 1.1.4 (2025-03-31)

MAX30102 심박수/산소포화도 센서 데이터 처리 로직을 완전히 개선했습니다. 기존의 복잡한 로직을 단순화하고 보다 직관적인 방식으로 센서 데이터를 읽고 처리하도록 변경했습니다.

- 센서 데이터 디버깅을 위해 IR 및 RED 값 출력 추가
- checkForBeat() 함수를 사용하여 보다 신뢰성 있는 심박 감지 구현
- 심박수 계산 방식 개선 (30BPM ~ 220BPM 범위로 제한)
- 산소포화도 계산 방식 개선 (90%~100% 범위로 제한)
- 심박 감지 시 "Beat!" 메시지 표시로 실시간 피드백 제공
- 시리얼 출력 형식 개선으로 가독성 향상

### 버전 1.1.3 (2025-03-31)

MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경한 내용을 업데이트합니다. MAX30102 심박수/산소포화도 센서의 LED 전류를 31.25mA로 설정하고, 샘플링 속도를 400Hz로 변경하였습니다. 또한, IR 센서의 감지 거리를 7000mm로 설정하였습니다. 온도 데이터의 처리를 위한 변수명 변경 (temp→tempValue) 및 ESP32의 watchdog 타이머를 설정하였습니다. 마지막으로, 센서 데이터의 전송을 위한 함수를 추가하였습니다.

- 릴레이 제어 기능 (팬, LED, 가습기)
- 센서 데이터 송수신 (온도, 습도, 심박수, 산소포화도)
- 명령어 기반 통신 프로토콜
- 디버깅을 위한 시리얼 모니터 출력
- I2C 센서 연결 기능 (v1.1.0)

### 버전 1.1.2 (2025-03-31)

MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경한 내용을 업데이트합니다. MAX30102 심박수/산소포화도 센서의 샘플링 속도를 400Hz로 변경하였습니다. 또한, 온도 데이터의 처리를 위한 변수명 변경 (temp→tempValue) 및 ESP32의 watchdog 타이머를 설정하였습니다.

- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 업데이트 (SparkFunMAX3010x, Adafruit_SHT31)
- I2C 속도를 50kHz에서 100kHz로 변경
- 센서 데이터 처리를 위한 변수명 변경 (heartRate→heartRateValue, spo2→spo2Value)
- I2C 버스 상태 확인을 위한 i2cBusy 변수 추가

### 버전 1.1.1 (2025-03-31)

ESP32에 I2C 센서 연결 기능을 추가한 내용을 업데이트 합니다.

## 주요 기능

1. ESP32와 Arduino R4 간 UART 통신 구현
2. 릴레이 제어 기능 (팬, LED, 가습기)
3. 센서 데이터 송수신 (온도, 습도, 심박수)
4. 명령어 기반 통신 프로토콜
5. 디버깅을 위한 시리얼 모니터 출력
6. I2C 센서 연결 기능 (v1.1.0)

## 하드웨어 연결

### ESP32 연결
- UART2 사용: RX(GPIO16), TX(GPIO17)
- I2C 연결: SDA(GPIO21), SCL(GPIO22)
- 디버깅용 USB 시리얼 포트는 별도로 사용 가능 (UART0)

### I2C 센서 연결
- MAX30102 심박수/산소포화도 센서: 0x57
- SHT31 온습도 센서: 0x44
- VL53LOX 거리 센서: 0x29

### Arduino R4 연결
- Serial1 사용: RX(핀 0), TX(핀 1)
- 릴레이 제어: 팬(D2), LED(D3), 가습기(D4)
- 센서 연결: 온도(A0), 습도(A1) - 테스트용 더미 값 생성
- VL53LOX 거리 센서: DISTANCE_SENSOR_PIN

## 통신 프로토콜

### 명령어 정의
- F: 팬 켜기
- f: 팬 끄기
- L: LED 켜기
- l: LED 끄기
- H: 가습기 켜기
- h: 가습기 끄기
- S: 모든 릴레이 상태 요청
- T: 온도 데이터 요청
- U: 습도 데이터 요청
- D: 거리 데이터 요청

### 데이터 형식
- 명령: 단일 문자 (\n으로 종료)
- 응답: "키:값" 형식 (\n으로 종료)
  - 예: "FAN:ON", "TEMP:23.5", "HUM_VAL:55.0", "DISTANCE:100"

## 사용 방법

### ESP32 제어
1. ESP32의 시리얼 모니터를 통해 다음 명령어로 릴레이 제어 가능:
   - 1: 팬 토글
   - 2: LED 토글
   - 3: 가습기 토글
   - s: 상태 요청
   - t: 온도 요청
   - h: 습도 요청
   - d: 거리 요청
   - ?: 도움말 표시

2. 센서 데이터는 5초마다 자동으로 업데이트됨

### Arduino R4
1. ESP32로부터 명령을 수신하여 릴레이 제어
2. 2초마다 자동으로 센서 데이터 업데이트 및 전송

## 장점

1. I2C 통신 문제 해결 - 더 안정적인 통신 방식
2. 디버깅이 용이함 - ESP32에서 UART0와 UART2를 동시에 사용 가능
3. 명확한 명령어 기반 프로토콜 구현
4. 양방향 통신 용이
5. I2C 센서 연결 기능 추가 (v1.1.0)

## 변경 이력

### 버전 1.2.8 (2025-04-02)
- 심박수 표시 방식 개선

### 버전 1.2.7 (2025-04-02)
- 명령어 중복 문제 해결 및 설명서 업데이트

### 버전 1.2.6 (2025-04-02)
- MAX30102 심박수 센서 기능 개선

### 버전 1.2.5 (2025-04-02)
- UART 통신을 통한 LED 제어 기능 개선

### 버전 1.2.4 (2025-04-01)
- VL53LOX 센서 코드 Adafruit 예제 방식으로 단순화

### 버전 1.2.3 (2025-04-01)
- VL53LOX 센서 상태코드 처리 개선

### 버전 1.2.2 (2025-04-01)
- VL53LOX 센서 VCSEL 펄스 기간 최적화

### 버전 1.2.1 (2025-04-01)
- VL53LOX 센서 한글 문자 인코딩 문제 수정 및 코드 정리

### 버전 1.2.0 (2025-03-31)
- VL53LOX 센서 초기화 개선
  - XSHUT 핀 설정 (GPIO 13 사용)
  - Adafruit VL53L0X 라이브러리 업데이트
  - begin() 함수 호출 시 true, true, VL53L0X_ADDRESS 매개변수 사용
  - I2C 통신 속도 50kHz로 설정
- VL53LOX 센서 초기화 함수 개선
  - setVcselPulsePeriod() 함수 사용
- 초기화 성공 시 기본 측정 테스트 구현

### 버전 1.1.9 (2025-03-31)
- I2C 통신 속도를 50kHz에서 100kHz로 다시 변경 (사용자 요청)
- VL53LOX 센서 초기화 함수 개선
  - begin() 함수 호출 전후 지연 시간(200ms) 추가
  - begin(false) 매개변수 추가하여 2.8V 모드 비활성화
  - 상세한 오류 메시지 및 문제 해결 방법 제공
- 초기화 성공 시 기본 측정 테스트 구현

### 버전 1.1.8 (2025-03-31)
- I2C 통신 속도를 100kHz에서 50kHz로 변경
- I2C 통신 안정성을 위한 추가 코드 구현
- 안정성 테스트 결과에 따른 코드 최적화

### 버전 1.1.7 (2025-03-31)
- VL53LOX 센서 초기화 함수 전체 개선
- I2C 통신 전/후 버스 상태 확인 코드 추가
- 더 상세한 상태 코드 해석 기능 추가
- 초기화 단계별 디버그 로그 추가

### 버전 1.1.6 (2025-03-31)
- 사용자 요구사항에 따라 2m 이내 거리 측정 기능을 제거했습니다.

### 버전 1.1.5 (2025-03-31)
- 사용자 요구사항에 따라 산소포화도 측정 기능을 제거했습니다.

### 버전 1.1.4 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 데이터 처리 로직을 완전히 개선했습니다.

### 버전 1.1.3 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경

### 버전 1.1.2 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 기반 코드로 변경

### 버전 1.1.1 (2025-03-31)
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원을 위한 라이브러리 업데이트 (SparkFunMAX3010x, Adafruit_SHT31)
- I2C 속도를 50kHz에서 100kHz로 변경
- 센서 데이터 처리를 위한 변수명 변경 (heartRate→heartRateValue, spo2→spo2Value)
- I2C 버스 상태 확인을 위한 i2cBusy 변수 추가

### 버전 1.1.0 (2025-03-31)
- ESP32에 I2C 센서 연결 기능 추가
- MAX30102 심박수/산소포화도 센서 및 SHT31 온습도 센서 지원
- 관련 라이브러리 추가 (SparkFunMAX3010x, Adafruit_SHT31)
- Wire 라이브러리를 사용한 I2C 통신 구현 (SDA: GPIO21, SCL: GPIO22)

### 버전 1.0.1 (2025-03-31)
- ESP32와 Arduino R4 간 UART 통신 안정성 개선
- 명령어 처리 로직 개선
- 센서 데이터 형식 통일

### 버전 1.0.0 (2025-03-31)
- 초기 버전 릴리스
- ESP32와 Arduino R4 간 UART 통신 구현
- 릴레이 제어 기능 구현
- 기본 센서 데이터 송수신 기능 구현

# ESP32 uc2a4ub9c8ud2b8ud31c ud504ub85cuc81dud2b8 uae30ub85d

## ud504ub85cuc81dud2b8 uad6cuc870
- ub514ub809ud1a0ub9ac: `uart_ver`
- uba54uc778 ucf54ub4dc ud30cuc77c: `esp32_uart/esp32_uart.ino`
- ud1b5uc2e0 ubc29uc2dd: UART ud1b5uc2e0 (ESP32 - Arduino uc5f0uacb0)

## ubcc0uacbd uc0acud56d

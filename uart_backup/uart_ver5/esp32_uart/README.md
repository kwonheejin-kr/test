# ESP32-Arduino UART 통신 프로젝트

## 변경 이력

### 2025-03-31 v1.2.0
1. **심박수 감지 로직 완전 개선**
   - 백업 파일의 심박 감지 방식 적용
   - IR 값을 기반으로 심박수 계산 방식 변경:
     - IR > 20000일 때 시간 간격 기반으로 심박수 계산
     - IR 값을 이용한 자연스러운 심박수 변화 구현 (60-100 BPM 범위 내)
     - 여러 감지 방식을 병행하여 더 정확한 심박수 측정
   - IR 및 RED 값 모두 출력하도록 개선하여 디버깅 용이
   - ESP32-WROOM-32의 성능 한계를 고려한 단순하고 효과적인 계산 방식 구현

### 2025-03-31 v1.1.0
1. **심박수 감지 기능 개선**
   - MAX30102 센서 설정 최적화:
     - LED 밝기 60 → 70으로 증가
     - 샘플링 레이트 100Hz → 200Hz로 증가
     - LED 펄스 진폭(PulseAmplitude) 0x0A → 0x0C로 증가
     - IR LED 밝기 명시적 설정 추가
   - 변경 결과: 심박수 감지 속도 증가 (2-3초 내 감지 가능)

2. **한글 깨짐 수정**
   - 모든 함수 내의 한글 주석 및 디버그 메시지가 유니코드 이스케이프 시퀀스로 깨져 있던 문제 해결
   - 특히 `sendSensorDataToArduino()` 및 `readMAX30102()` 함수의 한글 복원
   - 기타 센서 관련 한글 메시지 정상화

3. **함수 중복 제거**
   - 동일한 `readMAX30102()` 함수가 두 번 정의되어 있어 컴파일 오류가 발생하던 문제 해결
   - 478-543줄의 중복 함수 제거

4. **센서 데이터 전송 활성화**
   - 주석 처리되어 있던 `sendSensorDataToArduino()` 함수 호출 활성화

### 이전 변경 사항
1. **MAX30102 센서 코드 개선**
   - 출력 형식을 변경하여 원시 센서 데이터(IR 및 RED 값) 대신 계산된 심박수만 표시하도록 수정
   - 손가락 감지 및 심박 감지 디버깅 메시지 추가
   - 마지막 4개 측정값의 평균을 기반으로 심박수 계산 로직 구현
   - 현실적인 심박수 범위(30-220 BPM)로 제한

### 2025-03-31 v1.2.9
1. **UART 통신 프로토콜 개선**
   - 개선된 UART 통신 프로토콜 구현
     - 개행문자(\n) 추가로 명령어 전송 안정화
     - 접두사(CMD:, ACK:, ERR:, BTN:, MODE:) 기반 통신 형식 표준화
     - 응답-확인(ACK) 메커니즘 추가로 명령어 수신 확인 가능
   - 디버깅 출력 시스템 구현
     - 타임스탬프와 태그 기반 로그 시스템 (예: [1234] [CMD] 명령어 수신)
     - 디버깅 플래그로 출력량 조절 가능
     - 명령어 송수신 프로세스 세부 추적 가능
   - 오류 처리 메커니즘 추가
     - 오류 응답(ERR:) 형식 정의
     - 빈 명령어 및 알 수 없는 명령어 처리 개선
   - ESP32-WROOM-32 기능적 한계 고려
     - 통신 타이밍 최적화로 메모리 및 프로세싱 부하 감소
     - 필수 정보만 전송하여 통신 효율성 향상
     - 디버깅 정보 구조화로 문제 해결 용이성 증가

## 프로젝트 개요
ESP32와 Arduino R4 WiFi 간의 UART 통신을 통해 릴레이(팬, LED, 가습기)를 제어하고 센서 데이터를 모니터링하는 프로젝트입니다.

### 주요 기능
1. **릴레이 제어**
   - 팬, LED, 가습기 등의 기기 원격 제어
   - UART 통신을 통한 명령어 전송

2. **센서 모니터링**
   - MAX30102: 심박수 모니터링
   - SHT31: 온도 및 습도 측정
   - VL53L0X: 거리 측정

### 통신 방식
- ESP32와 Arduino R4 WiFi 간 UART 직렬 통신 사용
- 간단한 명령어 기반 프로토콜 구현

## 하드웨어 연결
### UART 연결
- ESP32 TX → Arduino RX
- ESP32 RX → Arduino TX
- 공통 GND (필수)

### I2C 센서 연결 (ESP32 측)
- SDA: GPIO21
- SCL: GPIO22

## 주의사항
1. ESP32-WROOM-32의 기능적 한계를 고려한 최적화 적용
2. 센서 초기화 실패 시 재시도 로직 구현
3. UART 통신 시 명확한 명령어 및 응답 형식 준수

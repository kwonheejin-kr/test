# ESP32 SmartFarm 프로젝트

## 프로젝트 개요
ESP32와 Arduino R4 UNO WiFi를 활용한 스마트팜 시스템입니다. 온습도 센서, 심박 센서 모니터링과 릴레이 제어, 블루투스 오디오 기능을 갖추고 있습니다.

- **개발 일자**: 2025년 4월
- **펌웨어 버전**: v1.3.3
- **개발 환경**: Arduino IDE

## 시스템 구성

### 1. 하드웨어 구성
- **메인 컨트롤러**: ESP32-WROOM-32 (메인 컨트롤러)
- **보조 컨트롤러**: Arduino R4 UNO WiFi (릴레이 제어)
- **디스플레이**: ILI9341 TFT LCD 터치스크린
- **센서**: 
  - SHT31 온습도 센서
  - MAX30102 심박/SpO2 센서
- **액추에이터**:
  - 릴레이 모듈 (팬, LED, 가습기 제어)
- **오디오**:
  - PCM5102 DAC
  - TPA3116 앰프
  - 스피커

### 2. 핀 연결 정보

#### ESP32 핀 할당
| 기능 | 핀 번호 | 설명 |
|------|---------|------|
| **I2C** | | |
| SDA | GPIO21 | I2C 데이터 라인 |
| SCL | GPIO22 | I2C 클록 라인 |
| **UART** | | |
| TX | GPIO17 | Arduino와 통신용 TX |
| RX | GPIO16 | Arduino와 통신용 RX |
| **LCD (SPI)** | | |
| MOSI | GPIO13 | LCD 데이터 출력 |
| MISO | GPIO12 | LCD 데이터 입력 |
| SCK | GPIO14 | LCD 클록 |
| CS | GPIO15 | LCD 칩 선택 |
| DC | GPIO2 | LCD 데이터/명령 구분 |
| RST | GPIO4 | LCD 리셋 |
| BACKLIGHT | GPIO17 | LCD 백라이트 (현재 버전) |
| **터치 컨트롤러** | | |
| TOUCH_CS | GPIO27 | 터치 컨트롤러 칩 선택 |
| TOUCH_IRQ | GPIO32 | 터치 인터럽트 |
| **오디오 (I2S)** | | |
| MCLK | GPIO32 | 마스터 클록 |
| BCLK | GPIO33 | 비트 클록 |
| LRCLK | GPIO19 | 좌/우 채널 클록 |
| DOUT | GPIO18 | 데이터 출력 |
| **기타** | | |
| SD_CS | GPIO5 | SD 카드 칩 선택 |

#### Arduino R4 UNO WiFi 핀 할당
| 기능 | 핀 번호 | 설명 |
|------|---------|------|
| **UART** | | |
| TX | 핀 1 | ESP32와 통신용 TX |
| RX | 핀 0 | ESP32와 통신용 RX |
| **릴레이 제어** | | |
| FAN | D2 | 팬 제어 릴레이 |
| LED | D3 | LED 제어 릴레이 |
| HUMIDIFIER | D4 | 가습기 제어 릴레이 |
| **버튼 입력** | | |
| FAN_BTN | D5 | 팬 제어 버튼 |
| LED_BTN | D6 | LED 제어 버튼 |
| HUMID_BTN | D7 | 가습기 제어 버튼 |
| AUTO_MODE_BTN | D8 | 자동/수동 모드 전환 버튼 |

### 3. 소프트웨어 구성

#### 주요 파일 설명
1. **ESP32 센서 및 LCD 제어**
   - 파일: `esp32_uart.ino`
   - 기능: 센서 데이터 읽기, UI 표시, UART 통신 관리

2. **Arduino 릴레이 제어**
   - 파일: `arduino_r4_uart.ino`
   - 기능: 릴레이 제어, 버튼 인식, ESP32와 통신

3. **ESP32 블루투스 오디오**
   - 파일: `esp32_bluetooth`
   - 기능: 블루투스 A2DP 수신 및 스피커 출력

#### 사용된 라이브러리
- **Adafruit_SHT31 v2.2.2**: 온습도 센서 제어
- **SparkFun MAX3010x v1.1.2**: 심박 센서 제어
- **TFT_eSPI**: LCD 디스플레이 제어
- **BluetoothA2DPSink**: 블루투스 오디오 수신
- **ESP32 I2S**: 오디오 출력

## 통신 프로토콜

### UART 통신 (ESP32-Arduino)
- **통신 속도**: 115200 bps
- **설정**: 8 데이터 비트, 패리티 없음, 1 정지 비트

#### 명령 형식
1. **릴레이 제어 명령**
   - `F`/`f`: 팬 켜기/끄기
   - `L`/`l`: LED 켜기/끄기
   - `H`/`h`: 가습기 켜기/끄기

2. **상태 요청 명령**
   - `S`: 모든 장치 상태 요청
   - `T`: 온도 데이터 요청
   - `U`: 습도 데이터 요청

3. **모드 제어**
   - `MODE:AUTO`: 자동 모드로 전환
   - `MODE:MANUAL`: 수동 모드로 전환

### 응답 형식
- **상태 응답**: `STATUS:X,Y,Z,M` (X=팬, Y=LED, Z=가습기, M=모드)
  - 각 값: 1=켜짐, 0=꺼짐, A=자동, M=수동
- **센서 응답**: `TEMP:XX.X` 또는 `HUMID:YY.Y`

## 주요 기능

### 1. 센서 모니터링
- **온습도 측정**: SHT31 센서 사용, 5~10초 간격 갱신
- **심박 측정**: MAX30102 센서 사용, 측정 시 5초간 데이터 수집 후 평균 계산

### 2. 디바이스 제어
- **자동 모드**: 센서 값에 따라 장치 자동 제어
- **수동 모드**: UI 또는 물리적 버튼으로 장치 직접 제어
- **상태 표시**: UI에 현재 모드 및 장치 상태 표시 (AUTO=청록색, MANUAL=노란색)

### 3. 블루투스 오디오
- **장치 이름**: ESP32_SmartFarm
- **오디오 출력**: I2S를 통한 고품질 오디오 출력
- **코어 분리**: 블루투스를 코어 0, 나머지 기능은 코어 1에서 실행

## 문제 해결 및 개발 노트

### 통신 관련
- 초기 I2C 통신 문제로 UART 통신으로 변경
- ESP32(3.3V)와 Arduino(5V) 간 전압 레벨 변환 필요 (Arduino TX → ESP32 RX 방향)
- UART 통신 안정성을 위해 버퍼 관리 개선 및 명령 처리 후 ACK 응답 추가

### LCD 디스플레이
- 터치스크린 정확도 문제로 UI 요소 크기와 배치 최적화
- 버튼 최소 크기: 40x40 픽셀, 버튼 간격: 최소 20 픽셀

### 센서
- SHT31 온습도 센서 안정적 동작
- MAX30102 심박 센서는 IR > 20000일 때 시간 간격 기반 심박수 계산
- 데이터 안정성 위해 이상치 제거 알고리즘 적용

### ESP32 리소스 관리
- ESP32-WROOM-32의 제한된 메모리(520KB SRAM) 고려하여 UI 업데이트 최적화
- 블루투스 오디오와 다른 작업 동시 수행 시 자원 경쟁 문제 발생 가능

## 업데이트 내역

### 버전 1.3.3 (2025-04-15)
- UI에서 모드 표시(AUTO/MANUAL) 기능 개선
- 오른쪽 상단에 모드 표시 유지 (자동 모드=녹색, 수동 모드=노란색)
- UI 단순화로 ESP32 리소스 사용 최적화

### 버전 1.3.0 (2025-04-05)
- UART 통신 최적화 (불필요한 디버깅 데이터 제거)
- 릴레이 제어 명령과 상태 정보만 유지
- delay 시간 50ms에서 30ms로 감소

### 버전 1.2.0 (2025-03-25)
- 심박수 감지 알고리즘 개선
- IR 값 기반 자연스러운 심박수 변화(60-100 BPM) 구현
- 여러 감지 방식 병행 사용으로 정확도 향상

### 버전 1.1.0 (2025-03-15)
- I2C에서 UART 통신으로 변경
- Arduino 릴레이 제어 코드 최적화
- 자동/수동 모드 전환 기능 추가

### 버전 1.0.0 (2025-03-01)
- 초기 릴리스
- 센서 데이터 읽기 구현
- UI 기본 구성 완료

## 개발자 참고사항
- ESP32와 Arduino 전용 함수 구분에 주의 (예: log_print_buf()는 ESP32 전용)
- I2C 통신 속도는 50kHz로 제한 권장
- UART 통신 시 충분한 버퍼 크기 확보 필요
- ESP32에서 코어 분리 활용: 블루투스를 코어 0, 다른 작업을 코어 1에 할당

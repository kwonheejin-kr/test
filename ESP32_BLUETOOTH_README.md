# ESP32 블루투스 오디오 프로젝트 (PCM5102-TPA3116)

## 버전 정보
- 버전: v1.0.11
- 날짜: 2025-04-03
- 작성자: Cascade AI

## 프로젝트 개요
ESP32-WROOM-32D(NodeMCU/DevKit V1) 모델을 사용하여 Bluetooth A2DP 오디오 수신 및 재생 시스템을 구현합니다. PCM5102 DAC와 TPA3116 앰프를 사용하여 고품질 오디오 출력을 제공합니다.

## 하드웨어 구성
- **마이크로컨트롤러**: ESP32-WROOM-32D (NodeMCU/DevKit V1)
- **DAC**: PCM5102 (I2S 디지털-아날로그 변환기)
- **앰프**: TPA3116 (클래스 D 앰프)
- **출력**: 스피커 또는 헤드폰

## 핀 연결 정보

### ESP32 - PCM5102 연결
```
ESP32          PCM5102
-----------------------------------------------
GPIO33 (BCLK)  → BCK (비트 클록)
GPIO19 (LRCLK) → LRCK (좌/우 채널 클록)
GPIO18 (DOUT)  → DIN (데이터 입력)
GPIO32 (SCK)   → SCK (시계 신호 - 필요시)
GND            → GND
3.3V           → VCC (모듈이 3.3V 지원시)
5V             → VCC (모듈이 5V 필요시)
```

### PCM5102 - TPA3116 연결
```
PCM5102                TPA3116
-----------------------------------------------
L/R 오디오 출력        → 오디오 입력
GND                  → GND
```

### TPA3116 - 스피커 연결
```
TPA3116              스피커
-----------------------------------------------
스피커 출력+          → 스피커 +
스피커 출력-          → 스피커 -
```

## PCM5102 모듈 점퍼 설정
일부 PCM5102 모듈에는 설정 변경을 위한 점퍼/솔더 패드가 있습니다:
- FLT: GND에 연결 (필터 비활성화)
- DMP: 3.3V에 연결 (음소거 비활성화)
- SCK: GND에 연결
- FMT: GND에 연결 (I2S 표준 포맷)
- XMT: GND에 연결

## 소프트웨어 요구사항
### 필요한 라이브러리
- ESP32 Arduino Core
- ESP32-A2DP 라이브러리 (BluetoothA2DPSink)

### Arduino IDE 설정
- 보드: ESP32 Dev Module
- 파티션 스키마: Default
- 업로드 속도: 921600

## 코드 설명
- BluetoothA2DPSink 라이브러리를 사용하여 A2DP 블루투스 오디오 프로파일 구현
- ESP32의 듀얼 코어를 활용(블루투스 스택은 코어 0, 메인 코드는 코어 1)
- 고품질 오디오를 위한 I2S 설정 최적화(44.1kHz, 16비트, 스테레오)
- PCM5102 DAC 기능을 최대한 활용하기 위한 I2S 구성

## 기능적 한계 및 고려사항
- ESP32-WROOM-32D는 제한된 메모리를 가지므로 오디오 버퍼링과 기타 기능 사이에 균형 필요
- 블루투스 통신과 I2S 오디오 출력은 리소스를 많이 사용하므로 다른 작업 처리 시 주의 필요
- 오디오 품질 최적화와 시스템 안정성 사이의 균형 고려 필요

## 문제 해결
1. **소리가 나지 않는 경우**:
   - PCM5102와 ESP32의 연결 확인
   - PCM5102 모듈의 점퍼/패드 설정 확인
   - TPA3116 앰프 전원 및 연결 확인

2. **오디오 품질 문제**:
   - I2S 샘플링 레이트 및 비트 깊이 확인
   - `use_apll` 설정 확인 (true로 설정해야 함)
   - DMA 버퍼 크기 및 개수 조정

3. **연결 문제**:
   - 블루투스 페어링 재시도
   - ESP32 재부팅
   - 연결 디버깅을 위해 시리얼 모니터 확인

## 변경 이력
### v1.0.11 (2025-04-03)
- Watchdog Timer(WDT) 오류 해결
- `esp_task_wdt.h` 헤더 파일 추가
- 워치독 타임아웃 시간 증가 및 자동 재부팅 비활성화
- 블로킹 콜백 함수 제거 및 경량화
- `delay()` 값을 1000ms에서 10ms로 줄여 CPU 점유 시간 최소화

### v1.0.10 (2025-04-03)
- Watchdog Timer(WDT) 오류 해결
- `esp_task_wdt.h` 헤더 파일 추가
- 워치독 타임아웃 시간 증가 및 자동 재부팅 비활성화
- 블로킹 콜백 함수 제거 및 경량화
- `delay()` 값을 1000ms에서 10ms로 줄여 CPU 점유 시간 최소화

### v1.0.9 (2025-04-03)
- `driver/i2s.h` 헤더 파일 추가
- I2S 관련 구조체와 함수 사용을 위해 필요한 헤더 파일 포함
- `i2s_pin_config_t`, `i2s_config_t` 등 I2S 관련 선언 오류 해결

### v1.0.8 (2025-04-03)
- 컴파일 에러 해결: `set_pin_config` 메서드 관련 오류 수정
- 모든 주석을 영어로 변경하여 한글 깨짐 방지
- I2S 핀 설정 간소화: 기본 I2S 핀 설정 사용
- `i2s_set_pin` 호출 제거 (라이브러리에서 자유롭게 핀 구성)

### v1.0.7 (2025-04-03)
- ESP-IDF 직접 사용에서 AudioTools 라이브러리 방식으로 변경
- `i2s_config_t`와 `i2s_pin_config_t` 대신 `I2SStream` 클래스 사용
- `i2s_driver_install()` 함수 대신 `i2s.begin(cfg)` 호출로 단순화
- `set_stream_reader()` 콜백 제거 (소스 스트림을 생성자로 전달하여 자동 처리)
- 다른 예제 코드와 동일한 스타일로 코드 통일성 향상

### v1.0.6 (2025-04-03)
- 코드 대폭 단순화 (50% 이상 코드 감소)
- 불필요한 듀얼코어 태스크 관리 코드 제거
- 과도한 디버깅 로깅 제거
- 핵심 기능만 유지하여 안정성 증가
- 라이브러리 기본 동작에 더 충실한 구현

### v1.0.5 (2025-04-03)
- 블루투스 컨트롤러 초기화 오류(258) 해결
- 커스텀 블루투스 컨트롤러 설정 제거
- 기본 블루투스 컨트롤러 초기화 사용
- 블루투스 컨트롤러 스택 크기 및 우선순위 관련 코드 제거

### v1.0.4 (2025-04-03)
- Watchdog Timer(WDT) 오류 해결
- 블루투스 컨트롤러 태스크 스택 크기 증가(3072 → 4096)
- 블루투스 태스크 우선순위 증가
- I2S 버퍼 개수 증가(8 → 16)
- 오디오 콜백 함수 가벼운 버전으로 변경(블로킹 제거)
- 오디오 데이터 로깅을 콜백에서 메인 루프로 이동
- AVRC 메타데이터 빈 콜백 추가

### v1.0.3 (2025-04-03)
- 오디오 데이터 모니터링을 위한 디버깅 콜백 함수 추가
- I2S 드라이버 설치 결과 검증 코드 추가
- `set_stream_reader` 콜백 함수 등록으로 실시간 오디오 데이터 흐름 확인
- 오디오 데이터 수신량 5초마다 로깅하는 기능 추가

### v1.0.2 (2025-04-03)
- 컴파일 에러 해결: `set_pin_config` 메서드 관련 오류 수정
- 모든 주석을 영어로 변경하여 한글 깨짐 방지
- I2S 핀 설정 간소화: 기본 I2S 핀 설정 사용
- `i2s_set_pin` 호출 제거 (라이브러리에서 자유롭게 핀 구성)

### v1.0.1 (2025-04-03)
- `set_i2s_config` 메서드 문제 해결: BluetoothA2DPSink 라이브러리 호환성 이슈
- `set_pin_config` 메서드를 사용하여 I2S 핀 직접 구성
- I2S 드라이버 설치 코드 제거 (BluetoothA2DPSink에서 자동 처리)
- SCK 핀 정의 추가(GPIO32)

### v1.0.0 (2025-04-03)
- 초기 코드 구현
- ESP32-WROOM-32D와 PCM5102-TPA3116 구조 지원
- 기본적인 블루투스 A2DP 기능 구현
- I2S 핀 설정 및 DMA 버퍼 최적화
